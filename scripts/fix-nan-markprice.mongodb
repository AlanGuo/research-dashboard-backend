// MongoDB Shell è„šæœ¬ï¼šä¿®å¤ markPrice ä¸­çš„ NaN å€¼
// ä½¿ç”¨æ–¹æ³•ï¼šmongosh research-dashboard < fix-nan-markprice.mongodb

// åˆ‡æ¢åˆ°æ­£ç¡®çš„æ•°æ®åº“
use('research-dashboard');

// æ£€æŸ¥å½“å‰ NaN markPrice çš„æ•°é‡
print('ğŸ“Š æ£€æŸ¥å½“å‰ NaN markPrice æ•°é‡...');
const nanCount = db.volume_backtests.countDocuments({
  "rankings.fundingRateHistory.markPrice": NaN
});
print(`å‘ç° ${nanCount} ä¸ªæ–‡æ¡£åŒ…å« NaN markPrice`);

if (nanCount === 0) {
  print('âœ… æ²¡æœ‰å‘ç° NaN markPriceï¼Œæ— éœ€ä¿®å¤');
} else {
  print('ğŸ”§ å¼€å§‹ä¿®å¤ NaN markPrice...');
  
  // ä½¿ç”¨èšåˆç®¡é“ä¿®å¤ NaN å€¼
  const result = db.volume_backtests.updateMany(
    {"rankings.fundingRateHistory.markPrice": NaN},
    [
      {
        $set: {
          rankings: {
            $map: {
              input: "$rankings",
              as: "ranking",
              in: {
                $mergeObjects: [
                  "$$ranking",
                  {
                    fundingRateHistory: {
                      $map: {
                        input: { $ifNull: ["$$ranking.fundingRateHistory", []] },
                        as: "funding",
                        in: {
                          $mergeObjects: [
                            "$$funding",
                            {
                              markPrice: {
                                $cond: [
                                  { $ne: ["$$funding.markPrice", "$$funding.markPrice"] }, // NaN æ£€æŸ¥
                                  null,
                                  "$$funding.markPrice"
                                ]
                              }
                            }
                          ]
                        }
                      }
                    }
                  }
                ]
              }
            }
          }
        }
      }
    ]
  );
  
  print(`âœ… ä¿®å¤å®Œæˆ:`);
  print(`   - åŒ¹é…çš„æ–‡æ¡£: ${result.matchedCount}`);
  print(`   - ä¿®æ”¹çš„æ–‡æ¡£: ${result.modifiedCount}`);
  
  // éªŒè¯ä¿®å¤ç»“æœ
  const remainingNaN = db.volume_backtests.countDocuments({
    "rankings.fundingRateHistory.markPrice": NaN
  });
  
  const nullCount = db.volume_backtests.countDocuments({
    "rankings.fundingRateHistory.markPrice": null
  });
  
  print(`ğŸ“Š ä¿®å¤åç»Ÿè®¡:`);
  print(`   - å‰©ä½™ NaN markPrice: ${remainingNaN}`);
  print(`   - null markPrice æ•°é‡: ${nullCount}`);
  
  if (remainingNaN === 0) {
    print('ğŸ‰ æ‰€æœ‰ NaN markPrice å·²æˆåŠŸä¿®å¤ä¸º null');
  } else {
    print('âš ï¸ ä»æœ‰éƒ¨åˆ† NaN markPrice æœªä¿®å¤');
  }
}

print('âœ… è„šæœ¬æ‰§è¡Œå®Œæˆ');
