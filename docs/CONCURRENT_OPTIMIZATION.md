# Binance Volume Backtest å¹¶å‘ä¼˜åŒ–æ–‡æ¡£

## æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº† Binance Volume Backtest æœåŠ¡ä¸­å®ç°çš„å¹¶å‘ä¼˜åŒ–ç­–ç•¥å’Œæœºåˆ¶ã€‚é€šè¿‡è¿™äº›ä¼˜åŒ–ï¼Œç³»ç»Ÿèƒ½å¤Ÿé«˜æ•ˆåœ°å¤„ç†å¤§é‡äº¤æ˜“å¯¹çš„æ•°æ®ç­›é€‰ã€é¢„åŠ è½½å’Œå›æµ‹è®¡ç®—ã€‚

## æ ¸å¿ƒä¼˜åŒ–ç‰¹æ€§

### 1. æ™ºèƒ½å¹¶å‘æ±  (Smart Concurrency Pool)

#### ç‰¹æ€§
- **è‡ªé€‚åº”å¹¶å‘æ§åˆ¶**: æ ¹æ®APIå“åº”æ—¶é—´å’Œé”™è¯¯ç‡åŠ¨æ€è°ƒæ•´å¹¶å‘æ•°
- **æŒ‡æ•°é€€é¿é‡è¯•**: å¤±è´¥è¯·æ±‚ä½¿ç”¨æ™ºèƒ½é‡è¯•æœºåˆ¶
- **æ€§èƒ½ç›‘æ§**: å®æ—¶ç›‘æ§ååé‡å’Œé”™è¯¯ç‡

#### å®ç°
```typescript
private async processConcurrentlyWithPool<T, R>(
  items: T[],
  processor: (item: T) => Promise<R>,
  options: {
    initialConcurrency?: number;
    maxConcurrency?: number;
    minConcurrency?: number;
    adaptiveThrottling?: boolean;
    retryFailedItems?: boolean;
    maxRetries?: number;
  }
): Promise<{ results: Map<T, R>; errors: Map<T, Error>; stats: any }>
```

#### æ€§èƒ½ç‰¹ç‚¹
- **åˆå§‹å¹¶å‘æ•°**: 5-8 (æ ¹æ®æ“ä½œç±»å‹è°ƒæ•´)
- **æœ€å¤§å¹¶å‘æ•°**: 10-20 (é¿å…APIé™æµ)
- **æœ€å°å¹¶å‘æ•°**: 1 (ç¡®ä¿ç¨³å®šæ€§)
- **è‡ªé€‚åº”è°ƒæ•´**: æ ¹æ®å“åº”æ—¶é—´å’Œé”™è¯¯ç‡è‡ªåŠ¨ä¼˜åŒ–

### 2. åˆ†é˜¶æ®µå¹¶å‘å¤„ç†

#### æ•°æ®å¤„ç†æµæ°´çº¿
```
1. äº¤æ˜“å¯¹ç­›é€‰ â†’ 2. æ•°æ®é¢„åŠ è½½ â†’ 3. æ»‘åŠ¨çª—å£æ›´æ–° â†’ 4. æ’è¡Œæ¦œè®¡ç®— â†’ 5. ç»“æœä¿å­˜
     â†“              â†“              â†“                â†“              â†“
   å¹¶å‘ç­›é€‰        æ‰¹é‡åŠ è½½        å¢é‡æ›´æ–°          å¹¶è¡Œè®¡ç®—        å¼‚æ­¥ä¿å­˜
```

#### å„é˜¶æ®µä¼˜åŒ–ç­–ç•¥

**äº¤æ˜“å¯¹ç­›é€‰é˜¶æ®µ**
- å¹¶å‘æ£€æŸ¥å†å²æ•°æ®å¯ç”¨æ€§
- æœŸè´§åˆçº¦å­˜åœ¨æ€§éªŒè¯
- ç¨³å®šå¸è¿‡æ»¤
- æ™ºèƒ½ç¼“å­˜å‡å°‘é‡å¤è®¡ç®—

**æ•°æ®é¢„åŠ è½½é˜¶æ®µ**
- åˆ†æ‰¹å¹¶å‘åŠ è½½Kçº¿æ•°æ®
- å¤±è´¥é¡¹ç›®å•ç‹¬é‡è¯•
- å†…å­˜ä½¿ç”¨ä¼˜åŒ–

**æ»‘åŠ¨çª—å£æ›´æ–°é˜¶æ®µ**
- å¢é‡æ•°æ®è·å–
- è¿‡æœŸæ•°æ®æ¸…ç†
- å¹¶å‘çª—å£è®¡ç®—

### 3. ç¼“å­˜ä¼˜åŒ–ç­–ç•¥

#### å¤šå±‚ç¼“å­˜æ¶æ„
```
äº¤æ˜“å¯¹ç­›é€‰ç¼“å­˜ (MongoDB)
    â†“
APIå“åº”ç¼“å­˜ (å†…å­˜, 1åˆ†é’Ÿ)
    â†“  
å†å²æ•°æ®ç¼“å­˜ (MongoDB, 24å°æ—¶)
```

#### ç¼“å­˜é”®ç­–ç•¥
```typescript
private generateFilterHash(
  referenceTime: Date,
  params: VolumeBacktestParamsDto
): string {
  const hashInput = {
    weekStart: referenceTime.toISOString().slice(0, 10),
    minHistoryDays: params.minHistoryDays || 365,
    requireFutures: params.requireFutures || false,
    excludeStablecoins: params.excludeStablecoins ?? true,
    quoteAsset: params.quoteAsset || 'USDT'
  };
  return createHash('sha256').update(JSON.stringify(hashInput)).digest('hex');
}
```

### 4. å†…å­˜ç®¡ç†ä¼˜åŒ–

#### æ»‘åŠ¨çª—å£æ•°æ®ç»“æ„
```typescript
interface VolumeWindow {
  symbol: string;
  data: KlineData[]; // æœ€å¤š24å°æ—¶æ•°æ®
  volume24h: number;
  quoteVolume24h: number;
}
```

#### å†…å­˜æ§åˆ¶ç­–ç•¥
- **æ•°æ®çª—å£é™åˆ¶**: æ¯ä¸ªäº¤æ˜“å¯¹æœ€å¤šä¿å­˜24å°æ—¶Kçº¿æ•°æ®
- **æ‰¹æ¬¡å¤„ç†**: å¤§é‡äº¤æ˜“å¯¹åˆ†æ‰¹å¤„ç†ï¼Œé¿å…å†…å­˜æº¢å‡º
- **åŠæ—¶æ¸…ç†**: å¤„ç†å®Œæˆåç«‹å³é‡Šæ”¾ä¸éœ€è¦çš„æ•°æ®

### 5. APIè°ƒç”¨ä¼˜åŒ–

#### è¯·æ±‚é¢‘ç‡æ§åˆ¶
```typescript
// åŠ¨æ€è°ƒæ•´è¯·æ±‚å»¶è¿Ÿ
private async delay(ms: number): Promise<void> {
  return new Promise(resolve => setTimeout(resolve, ms));
}

// æ‰¹é‡è¯·æ±‚ç®¡ç†
private async loadSymbolKlinesBatch(
  symbols: string[],
  startTime: Date,
  endTime: Date,
  maxRetries: number = 3,
  batchSize: number = 10
): Promise<Map<string, KlineData[] | null>>
```

#### é”™è¯¯å¤„ç†å’Œé‡è¯•
- **æ™ºèƒ½é‡è¯•**: æŒ‡æ•°é€€é¿ç®—æ³•
- **é”™è¯¯åˆ†ç±»**: åŒºåˆ†ç½‘ç»œé”™è¯¯ã€APIé™æµã€æ•°æ®ä¸å­˜åœ¨ç­‰
- **é™çº§ç­–ç•¥**: éƒ¨åˆ†å¤±è´¥æ—¶ç»§ç»­å¤„ç†å…¶ä»–æ•°æ®

## æ€§èƒ½æŒ‡æ ‡

### å¹¶å‘å¤„ç†èƒ½åŠ›
- **äº¤æ˜“å¯¹ç­›é€‰**: 10-20 ä¸ª/ç§’ (å–å†³äºå†å²æ•°æ®æ£€æŸ¥)
- **Kçº¿æ•°æ®åŠ è½½**: 8-15 ä¸ªäº¤æ˜“å¯¹/ç§’
- **æ»‘åŠ¨çª—å£æ›´æ–°**: 15-25 ä¸ªäº¤æ˜“å¯¹/ç§’
- **æ’è¡Œæ¦œè®¡ç®—**: æ¯«ç§’çº§ (å†…å­˜è®¡ç®—)

### å†…å­˜ä½¿ç”¨
- **å•ä¸ªäº¤æ˜“å¯¹**: ~2-5KB (24å°æ—¶Kçº¿æ•°æ®)
- **100ä¸ªäº¤æ˜“å¯¹**: ~500KB-1MB
- **1000ä¸ªäº¤æ˜“å¯¹**: ~5-10MB

### APIè°ƒç”¨ä¼˜åŒ–
- **ç¼“å­˜å‘½ä¸­ç‡**: 80-95% (é‡å¤æŸ¥è¯¢)
- **APIè°ƒç”¨å‡å°‘**: 70-90% (é€šè¿‡ç¼“å­˜)
- **å¹¶å‘è°ƒç”¨**: 8-15ä¸ª/ç§’ (é¿å…é™æµ)

## é…ç½®å‚æ•°

### å¹¶å‘æ§åˆ¶å‚æ•°
```typescript
interface ConcurrencyConfig {
  initialConcurrency: number;    // åˆå§‹å¹¶å‘æ•° (é»˜è®¤: 5)
  maxConcurrency: number;        // æœ€å¤§å¹¶å‘æ•° (é»˜è®¤: 15)
  minConcurrency: number;        // æœ€å°å¹¶å‘æ•° (é»˜è®¤: 1)
  adaptiveThrottling: boolean;   // è‡ªé€‚åº”é™æµ (é»˜è®¤: true)
  retryFailedItems: boolean;     // é‡è¯•å¤±è´¥é¡¹ (é»˜è®¤: true)
  maxRetries: number;           // æœ€å¤§é‡è¯•æ¬¡æ•° (é»˜è®¤: 3)
}
```

### æ‰¹å¤„ç†å‚æ•°
```typescript
interface BatchConfig {
  batchSize: number;            // æ‰¹æ¬¡å¤§å° (é»˜è®¤: 40)
  requestDelay: number;         // è¯·æ±‚é—´å»¶è¿Ÿ (é»˜è®¤: 100ms)
  timeoutMs: number;           // è¯·æ±‚è¶…æ—¶ (é»˜è®¤: 30000ms)
}
```

## ä½¿ç”¨ç¤ºä¾‹

### åŸºç¡€å›æµ‹è°ƒç”¨
```typescript
const params: VolumeBacktestParamsDto = {
  startTime: '2024-12-01T00:00:00.000Z',
  endTime: '2024-12-01T12:00:00.000Z',
  limit: 50,
  minVolumeThreshold: 10000,
  quoteAsset: 'USDT',
  granularityHours: 4,
  concurrency: 8,  // å¹¶å‘æ•°
  minHistoryDays: 365,
  requireFutures: false,
  excludeStablecoins: true
};

const result = await volumeBacktestService.executeVolumeBacktest(params);
```

### é«˜å¹¶å‘é…ç½®
```typescript
const highConcurrencyParams = {
  ...params,
  concurrency: 15,        // æ›´é«˜å¹¶å‘æ•°
  granularityHours: 8,    // å‡å°‘è®¡ç®—é¢‘ç‡
  limit: 30              // å‡å°‘æ’è¡Œæ¦œå¤§å°
};
```

## ç›‘æ§å’Œè°ƒè¯•

### æ€§èƒ½ç›‘æ§æ—¥å¿—
ç³»ç»Ÿæä¾›è¯¦ç»†çš„æ€§èƒ½ç›‘æ§æ—¥å¿—ï¼š

```
ğŸ“Š ä¼˜åŒ–æ»‘åŠ¨çª—å£æ›´æ–°å®Œæˆ: æˆåŠŸ 95/100 (95.0%), å¤±è´¥ 5
   å¤„ç†ç»Ÿè®¡: è€—æ—¶ 2340ms, å¹³å‡å“åº” 234ms, å¹¶å‘è°ƒæ•´ 3 æ¬¡
âš¡ æ‰¹é‡åŠ è½½å®Œæˆ: 95/100 ä¸ªäº¤æ˜“å¯¹æˆåŠŸ

ğŸ“ˆ æœ€ç»ˆæ€§èƒ½æŠ¥å‘Š:
   æ€»å‘¨æœŸ: 12, æ€»è€—æ—¶: 45.2s
   å¹³å‡æ¯å‘¨æœŸ: 3766ms (æ•°æ®2100ms + è®¡ç®—89ms + ä¿å­˜125ms)
   ååé‡: 956.6 å‘¨æœŸ/å°æ—¶
```

### é”™è¯¯å¤„ç†æ—¥å¿—
```
âš ï¸ ADAUSDT æ£€æŸ¥å¤±è´¥: å†å²æ•°æ®ä¸è¶³365å¤©
âŒ XRPUSDT æœ€ç»ˆåŠ è½½å¤±è´¥: ç½‘ç»œè¶…æ—¶
ğŸ”„ å¯¹ 5 ä¸ªå¤±è´¥çš„äº¤æ˜“å¯¹è¿›è¡Œä¿å®ˆé‡è¯•...
```

## æ€§èƒ½æµ‹è¯•

### å¿«é€Ÿæµ‹è¯•
```bash
cd research-dashboard-backend
./scripts/run-concurrent-test.sh quick
```

### å®Œæ•´æ€§èƒ½æµ‹è¯•
```bash
./scripts/run-concurrent-test.sh full
```

### è‡ªå®šä¹‰æµ‹è¯•
```bash
node test-concurrent-performance.js --full
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **APIé™æµé”™è¯¯**
   - é™ä½å¹¶å‘æ•° (`concurrency: 3-5`)
   - å¢åŠ è¯·æ±‚å»¶è¿Ÿ (`requestDelay: 200-500ms`)

2. **å†…å­˜ä½¿ç”¨è¿‡é«˜**
   - å‡å°‘æ‰¹å¤„ç†å¤§å° (`batchSize: 20-30`)
   - å¢åŠ å¤„ç†ç²’åº¦ (`granularityHours: 8-12`)

3. **æ•°æ®è·å–å¤±è´¥ç‡é«˜**
   - æ£€æŸ¥ç½‘ç»œè¿æ¥
   - éªŒè¯Binance APIå¯ç”¨æ€§
   - è°ƒæ•´é‡è¯•ç­–ç•¥

### æ€§èƒ½è°ƒä¼˜å»ºè®®

1. **é«˜é¢‘äº¤æ˜“åœºæ™¯**: 
   - `concurrency: 12-15`
   - `granularityHours: 2-4`
   - `batchSize: 50-80`

2. **ç¨³å®šæ€§ä¼˜å…ˆ**:
   - `concurrency: 5-8`
   - `granularityHours: 6-8`
   - `maxRetries: 5`

3. **å†…å­˜å—é™ç¯å¢ƒ**:
   - `concurrency: 3-5`
   - `batchSize: 20-30`
   - å¯ç”¨æ›´æ¿€è¿›çš„æ•°æ®æ¸…ç†

## æœªæ¥ä¼˜åŒ–æ–¹å‘

### è®¡åˆ’ä¸­çš„æ”¹è¿›
1. **Redisç¼“å­˜é›†æˆ**: åˆ†å¸ƒå¼ç¼“å­˜æ”¯æŒ
2. **æµå¼å¤„ç†**: å¤§æ•°æ®é›†çš„æµå¼å¤„ç†
3. **è´Ÿè½½å‡è¡¡**: å¤šå®ä¾‹å¹¶å‘å¤„ç†
4. **WebSocketæ”¯æŒ**: å®æ—¶æ•°æ®æ›´æ–°
5. **æœºå™¨å­¦ä¹ ä¼˜åŒ–**: æ™ºèƒ½å¹¶å‘æ•°é¢„æµ‹

### æ‰©å±•æ€§è€ƒè™‘
- **æ°´å¹³æ‰©å±•**: æ”¯æŒå¤šä¸ªå¤„ç†èŠ‚ç‚¹
- **æ•°æ®åˆ†ç‰‡**: æŒ‰æ—¶é—´æˆ–äº¤æ˜“å¯¹åˆ†ç‰‡å¤„ç†
- **å¼‚æ­¥é˜Ÿåˆ—**: åŸºäºæ¶ˆæ¯é˜Ÿåˆ—çš„ä»»åŠ¡åˆ†å‘
- **å¾®æœåŠ¡æ¶æ„**: æœåŠ¡æ‹†åˆ†å’Œç‹¬ç«‹æ‰©å±•

## æ€»ç»“

é€šè¿‡å®æ–½è¿™äº›å¹¶å‘ä¼˜åŒ–ç­–ç•¥ï¼ŒBinance Volume BacktestæœåŠ¡èƒ½å¤Ÿï¼š

- **æé«˜å¤„ç†é€Ÿåº¦**: ç›¸æ¯”ä¸²è¡Œå¤„ç†æå‡5-10å€
- **é™ä½èµ„æºæ¶ˆè€—**: æ™ºèƒ½ç¼“å­˜å‡å°‘70-90%çš„APIè°ƒç”¨
- **å¢å¼ºç¨³å®šæ€§**: è‡ªé€‚åº”é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
- **æ”¹å–„ç”¨æˆ·ä½“éªŒ**: æ›´å¿«çš„å“åº”æ—¶é—´å’Œæ›´è¯¦ç»†çš„è¿›åº¦åé¦ˆ

è¿™äº›ä¼˜åŒ–ä½¿å¾—ç³»ç»Ÿèƒ½å¤Ÿé«˜æ•ˆå¤„ç†å¤§è§„æ¨¡çš„å†å²æ•°æ®å›æµ‹ä»»åŠ¡ï¼ŒåŒæ—¶ä¿æŒè‰¯å¥½çš„ç¨³å®šæ€§å’Œå¯ç»´æŠ¤æ€§ã€‚