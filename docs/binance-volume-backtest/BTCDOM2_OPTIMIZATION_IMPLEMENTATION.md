# BTCDOM2 æ€§èƒ½ä¼˜åŒ–å®æ–½æŒ‡å—

## ğŸ¯ åŸºäºå®é™…æµ‹è¯•ç»“æœçš„åˆ†æ

### ğŸ“Š æœåŠ¡å™¨æ€§èƒ½è¯„ä¼°
```
CPUæ€§èƒ½æµ‹è¯•: 1376.82ms (è¾ƒæ…¢)
JSONåºåˆ—åŒ–: 398.81ms, 9MB (å½±å“å“åº”é€Ÿåº¦)
æ¨¡æ‹Ÿå›æµ‹: 142.73ms/511ä¸ªæ•°æ®ç‚¹ (å®é™…ç®—æ³•åº”è¯¥ä¸æ…¢)
æœåŠ¡å™¨é…ç½®: 2æ ¸CPU, 7.39GBå†…å­˜
```

### ğŸ” é—®é¢˜å®šä½
æ ¹æ®æµ‹è¯•ç»“æœï¼Œ**çœŸæ­£çš„æ€§èƒ½ç“¶é¢ˆ**å¯èƒ½æ˜¯ï¼š

1. **JSONå“åº”è¿‡å¤§**: 9MBçš„å“åº”æ•°æ®åºåˆ—åŒ–éœ€è¦398ms
2. **ç½‘ç»œä¼ è¾“æ…¢**: å‰åç«¯ä¹‹é—´çš„æ•°æ®ä¼ è¾“
3. **CPUæ€§èƒ½ç›¸å¯¹è¾ƒä½**: æ¯”æœ¬åœ°ç¯å¢ƒæ…¢30-50å€
4. **è°ƒè¯•æ—¥å¿—å¼€é”€**: ç”Ÿäº§ç¯å¢ƒä»åœ¨è¾“å‡ºå¤§é‡è°ƒè¯•ä¿¡æ¯

## ğŸš€ ç«‹å³å¯å®æ–½çš„ä¼˜åŒ– (å·²å®æ–½)

### 1. æ€§èƒ½ç›‘æ§å¢å¼º
```typescript
// å·²æ·»åŠ è¯¦ç»†çš„æ€§èƒ½ç›‘æ§æ—¥å¿—
[PERF] å¼€å§‹BTCDOM2å›æµ‹ï¼Œæ•°æ®ç‚¹æ•°: 511
[PERF] å›æµ‹è¿›åº¦: 20.0% (102/511), è€—æ—¶: 1234ms
[PERF] selectShortCandidates è€—æ—¶: 45ms, å€™é€‰æ•°: 200, ç¬¦åˆæ¡ä»¶: 15
[PERF] BTCDOM2å›æµ‹å®Œæˆ:
  - æ•°æ®å¤„ç†è€—æ—¶: 2000ms
  - æ€§èƒ½è®¡ç®—è€—æ—¶: 100ms
  - æ€»è€—æ—¶: 2100ms
  - å¹³å‡æ¯ä¸ªæ•°æ®ç‚¹: 4.11ms
```

### 2. ç”Ÿäº§ç¯å¢ƒè°ƒè¯•æ—¥å¿—ä¼˜åŒ–
```typescript
// åªåœ¨å¼€å‘ç¯å¢ƒè¾“å‡ºè°ƒè¯•æ—¥å¿—
if (process.env.NODE_ENV === 'development') {
  console.warn(`[DEBUG] åˆ†æ•°å¼‚å¸¸...`);
}
```

### 3. æ—©æœŸç»ˆæ­¢ä¼˜åŒ–
```typescript
// æå‰æ£€æŸ¥æ— æ•ˆæ¡ä»¶ï¼Œé¿å…å¤æ‚è®¡ç®—
if (totalCandidates === 0) {
  return earlyReturn;
}
```

## ğŸ“ˆ å“åº”ä¼˜åŒ–ç­–ç•¥

### 1. **å‡å°‘å“åº”æ•°æ®é‡**
```typescript
// å‹ç¼©å“åº”æ•°æ®ï¼Œç§»é™¤éå¿…è¦å­—æ®µ
const compressedResult = {
  ...result,
  snapshots: result.snapshots.map(snapshot => ({
    // åªä¿ç•™å…³é”®æ•°æ®
    timestamp: snapshot.timestamp,
    totalValue: snapshot.totalValue,
    totalPnl: snapshot.totalPnl,
    // å‹ç¼© positions æ•°æ®
    positions: snapshot.shortPositions.map(pos => ({
      symbol: pos.symbol,
      quantity: Math.round(pos.quantity * 100) / 100, // å‡å°‘ç²¾åº¦
      pnl: Math.round(pos.pnl * 100) / 100
    }))
  }))
};
```

### 2. **å¯ç”¨å“åº”å‹ç¼©**
```typescript
// åœ¨ next.config.ts ä¸­å¯ç”¨ gzip å‹ç¼©
const nextConfig = {
  compress: true,
  // å…¶ä»–é…ç½®...
};
```

### 3. **åˆ†é¡µå“åº”ç­–ç•¥**
```typescript
// åˆ†æ‰¹è¿”å›æ•°æ®ï¼Œæ”¯æŒå¢é‡åŠ è½½
if (params.pageSize && params.pageNumber) {
  const startIndex = params.pageNumber * params.pageSize;
  const endIndex = startIndex + params.pageSize;
  
  return {
    ...result,
    snapshots: result.snapshots.slice(startIndex, endIndex),
    pagination: {
      total: result.snapshots.length,
      pageSize: params.pageSize,
      pageNumber: params.pageNumber,
      hasMore: endIndex < result.snapshots.length
    }
  };
}
```

## ğŸ”§ æœåŠ¡å™¨ç¡¬ä»¶ä¼˜åŒ–å»ºè®®

### 1. **CPUå‡çº§æ–¹æ¡ˆ**
```bash
# å½“å‰: 2æ ¸CPUï¼Œæ€§èƒ½è¾ƒä½
# å»ºè®®: å‡çº§åˆ°4æ ¸æˆ–8æ ¸è®¡ç®—ä¼˜åŒ–å‹å®ä¾‹
# é¢„æœŸæå‡: 50-100%æ€§èƒ½æå‡
```

### 2. **Node.jsä¼˜åŒ–é…ç½®**
```bash
# å¯åŠ¨æ—¶ä¼˜åŒ–å‚æ•°
node --max-old-space-size=4096 \
     --optimize-for-size \
     --gc-interval=100 \
     app.js
```

### 3. **PM2é…ç½®ä¼˜åŒ–**
```javascript
// ecosystem.config.js
module.exports = {
  apps: [{
    name: 'btcdom2-api',
    script: './src/main.js',
    instances: 'max', // åˆ©ç”¨æ‰€æœ‰CPUæ ¸å¿ƒ
    exec_mode: 'cluster',
    max_memory_restart: '2G',
    node_args: '--max-old-space-size=2048'
  }]
};
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–ä¼˜å…ˆçº§

| ä¼˜åŒ–é¡¹ç›® | é¢„æœŸæå‡ | å®æ–½éš¾åº¦ | ä¼˜å…ˆçº§ |
|---------|---------|---------|-------|
| ç§»é™¤ç”Ÿäº§è°ƒè¯•æ—¥å¿— | 10-20% | ç®€å• | ğŸ”¥ é«˜ |
| å“åº”æ•°æ®å‹ç¼© | 30-50% | ç®€å• | ğŸ”¥ é«˜ |
| å¯ç”¨gzipå‹ç¼© | 20-30% | ç®€å• | ğŸ”¥ é«˜ |
| CPUç¡¬ä»¶å‡çº§ | 50-100% | ä¸­ç­‰ | â­ ä¸­ |
| ç®—æ³•ç¼“å­˜ä¼˜åŒ– | 20-40% | å¤æ‚ | â­ ä¸­ |
| åˆ†é¡µå“åº” | 40-60% | ä¸­ç­‰ | â­ ä¸­ |

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨è®¡åˆ’

### Phase 1: ç«‹å³ä¼˜åŒ– (ä»Šå¤©)
1. âœ… å·²æ·»åŠ æ€§èƒ½ç›‘æ§
2. âœ… å·²ä¼˜åŒ–è°ƒè¯•æ—¥å¿—
3. ğŸ”„ å¯ç”¨å“åº”å‹ç¼©
4. ğŸ”„ å‡å°‘å“åº”æ•°æ®ç²¾åº¦

### Phase 2: çŸ­æœŸä¼˜åŒ– (æœ¬å‘¨)
1. å®æ–½å“åº”æ•°æ®å‹ç¼©
2. é…ç½®gzipå‹ç¼©
3. æœåŠ¡å™¨CPUå‡çº§è¯„ä¼°
4. æ·»åŠ è¿›åº¦æ¡UIåé¦ˆ

### Phase 3: ä¸­æœŸä¼˜åŒ– (ä¸‹å‘¨)
1. ç®—æ³•ç¼“å­˜æœºåˆ¶
2. åˆ†é¡µå“åº”æ”¯æŒ
3. WebSocketå®æ—¶è¿›åº¦æ¨é€
4. ç»“æœç¼“å­˜ç³»ç»Ÿ

## ğŸ”¬ æµ‹è¯•éªŒè¯æ–¹æ¡ˆ

### 1. æ€§èƒ½æµ‹è¯•è„šæœ¬
```bash
# æµ‹è¯•å½“å‰æ€§èƒ½
time curl -X POST "http://your-server/api/btcdom2/backtest" \
  -H "Content-Type: application/json" \
  -d '{"startDate":"2025-01-01","endDate":"2025-06-20",...}'

# å¯¹æ¯”ä¼˜åŒ–å‰åçš„å“åº”æ—¶é—´
```

### 2. ç›‘æ§æŒ‡æ ‡
- æ€»å“åº”æ—¶é—´
- æ•°æ®å¤„ç†æ—¶é—´  
- JSONåºåˆ—åŒ–æ—¶é—´
- ç½‘ç»œä¼ è¾“æ—¶é—´
- å†…å­˜ä½¿ç”¨æƒ…å†µ

ç°åœ¨ä½ å¯ä»¥å…ˆéƒ¨ç½²è¿™äº›åŸºç¡€ä¼˜åŒ–ï¼Œç„¶åè§‚å¯Ÿæ€§èƒ½æ”¹å–„æƒ…å†µï¼
